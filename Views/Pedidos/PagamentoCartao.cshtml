@model CheckoutViewModel

@{
    ViewData["Title"] = "Pagamento com Cartão - Malwaro";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h4><i class="fas fa-credit-card"></i> Pagamento com Cartão de Crédito</h4>
                </div>
                <div class="card-body">
                    <form method="post" asp-action="ConfirmarPagamento">
                        <input type="hidden" name="pedidoId" value="@Model.PedidoId" />
                        <input type="hidden" name="numeroParcelas" id="numeroParcelasHidden" value="1" />
                        <input type="hidden" name="taxaJuros" id="taxaJurosHidden" value="0" />

                        <!-- Informações do Pagamento -->
                        <div class="alert alert-info">
                            <strong>Valor a Pagar:</strong> R$ @Model.Total.ToString("N2")
                            <br />
                            <strong>Pedido:</strong> #@Model.PedidoId
                        </div>

                        <!-- Número do Cartão -->
                        <div class="form-group mb-3">
                            <label for="cardNumber" class="form-label">Número do Cartão</label>
                            <input type="text" class="form-control" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" required />
                        </div>

                        <!-- Nome do Titular -->
                        <div class="form-group mb-3">
                            <label for="cardName" class="form-label">Nome do Titular</label>
                            <input type="text" class="form-control" id="cardName" placeholder="NOME COMPLETO" required />
                        </div>

                        <!-- Data de Validade e CVV -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="cardExpiry" class="form-label">Validade (MM/AA)</label>
                                    <input type="text" class="form-control" id="cardExpiry" placeholder="MM/AA" maxlength="5" required />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="cardCvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cardCvv" placeholder="000" maxlength="4" required />
                                </div>
                            </div>
                        </div>

                        <!-- Seleção de Parcelas -->
                        <div class="form-group mb-3">
                            <label for="numeroParcelas" class="form-label">Número de Parcelas</label>
                            <select class="form-control" id="numeroParcelas" name="numeroParcelas" onchange="atualizarValorParcelas()" required>
                                <option value="1">1x de R$ @Model.Total.ToString("N2") (sem juros)</option>
                                <option value="2">2x de R$ @(Model.Total / 2).ToString("N2") (sem juros)</option>
                                <option value="3">3x de R$ @(Model.Total / 3).ToString("N2") (sem juros)</option>
                                <option value="4">4x de R$ @(Model.Total / 4).ToString("N2") (sem juros)</option>
                                <option value="5">5x de R$ @(Model.Total / 5).ToString("N2") (sem juros)</option>
                                <option value="6">6x de R$ @(Model.Total / 6 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="7">7x de R$ @(Model.Total / 7 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="8">8x de R$ @(Model.Total / 8 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="9">9x de R$ @(Model.Total / 9 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="10">10x de R$ @(Model.Total / 10 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="11">11x de R$ @(Model.Total / 11 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                                <option value="12">12x de R$ @(Model.Total / 12 * 1.015).ToString("N2") (com 1,5% de juros)</option>
                            </select>
                        </div>

                        <!-- CPF do Titular -->
                        <div class="form-group mb-3">
                            <label for="cardCpf" class="form-label">CPF do Titular</label>
                            <input type="text" class="form-control" id="cardCpf" placeholder="000.000.000-00" maxlength="14" required />
                        </div>

                        <!-- Checkbox de Termos -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="termsCheck" required />
                            <label class="form-check-label" for="termsCheck">
                                Concordo com os termos e condições de pagamento
                            </label>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-lock"></i> Pagar R$ @Model.Total.ToString("N2")
                            </button>
                            <a href="@Url.Action("Checkout", "Pedidos", new { pedidoId = Model.PedidoId })" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>

                        <p class="text-muted small mt-3 text-center">
                            <i class="fas fa-lock"></i> Seus dados estão seguros e criptografados
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Formatar número do cartão
    document.getElementById("cardNumber").addEventListener("input", function(e) {
        let value = e.target.value.replace(/\s/g, "");
        let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
        e.target.value = formattedValue;
    });

    // Formatar data de validade
    document.getElementById("cardExpiry").addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length >= 2) {
            value = value.slice(0, 2) + "/" + value.slice(2, 4);
        }
        e.target.value = value;
    });

    // Formatar CPF
    document.getElementById("cardCpf").addEventListener("input", function(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (value.length > 0) {
            value = value.slice(0, 3) + "." + value.slice(3, 6) + "." + value.slice(6, 9) + "-" + value.slice(9, 11);
        }
        e.target.value = value;
    });

    // Validar CVV (apenas números)
    document.getElementById("cardCvv").addEventListener("input", function(e) {
        e.target.value = e.target.value.replace(/\D/g, "");
    });

    // Atualizar valor das parcelas
    function atualizarValorParcelas() {
        const numeroParcelas = document.getElementById("numeroParcelas").value;
        const total = @Model.Total;
        let taxa = 0;

        if (numeroParcelas > 5) {
            taxa = 0.015; // 1,5% de juros
        }

        document.getElementById("numeroParcelasHidden").value = numeroParcelas;
        document.getElementById("taxaJurosHidden").value = taxa;
    }
</script>
